{
  "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "region": {
      "type": "string",
      "defaultValue": "westus3",
      "metadata": {
        "description": "Region for all resource groups (e.g., westus3)."
      }
    }
  },
  "variables": {
    "rgDev": "rg-petclinic-dev",
    "rgTest": "rg-petclinic-testing",
    "rgProd": "rg-petclinic-prod",
    "rgSonar": "rg-sonarqube",

    "dbAdminPassword": "Replace-Me-StrongPassword-123!",
    "sonarUniqueSuffix": "[substring(uniqueString(subscription().subscriptionId, 'sonarqube'), 0, 6)]",
    "sonarAppName": "[format('sonar-petclinic-{0}', variables('sonarUniqueSuffix'))]"
  },
  "resources": [
    {
      "type": "Microsoft.Resources/resourceGroups",
      "apiVersion": "2021-04-01",
      "name": "[variables('rgDev')]",
      "location": "[parameters('region')]",
      "properties": {}
    },
    {
      "type": "Microsoft.Resources/resourceGroups",
      "apiVersion": "2021-04-01",
      "name": "[variables('rgTest')]",
      "location": "[parameters('region')]",
      "properties": {}
    },
    {
      "type": "Microsoft.Resources/resourceGroups",
      "apiVersion": "2021-04-01",
      "name": "[variables('rgProd')]",
      "location": "[parameters('region')]",
      "properties": {}
    },
    {
      "type": "Microsoft.Resources/resourceGroups",
      "apiVersion": "2021-04-01",
      "name": "[variables('rgSonar')]",
      "location": "[parameters('region')]",
      "properties": {}
    },

    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2021-04-01",
      "name": "Deploy-PetClinic-Dev",
      "resourceGroup": "[variables('rgDev')]",
      "dependsOn": [
        "[resourceId('Microsoft.Resources/resourceGroups', variables('rgDev'))]"
      ],
      "properties": {
        "expressionEvaluationOptions": { "scope": "inner" },
        "mode": "Incremental",
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "parameters": {
            "environmentName": { "type": "string" },
            "region": { "type": "string" },
            "dbAdminPassword": { "type": "secureString" }
          },
          "variables": {
            "uniqueSuffix": "[substring(uniqueString(resourceGroup().id), 0, 6)]",
            "appServicePlanName": "[format('plan-petclinic-{0}', parameters('environmentName'))]",
            "webAppName": "[format('app-petclinic-{0}-{1}', parameters('environmentName'), variables('uniqueSuffix'))]",
            "postgresServerName": "[format('db-petclinic-{0}-{1}', parameters('environmentName'), variables('uniqueSuffix'))]",
            "databaseName": "petclinic",
            "acrName": "[format('acrpetclinic{0}{1}', parameters('environmentName'), variables('uniqueSuffix'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Web/serverfarms",
              "apiVersion": "2022-03-01",
              "name": "[variables('appServicePlanName')]",
              "location": "[parameters('region')]",
              "sku": { "name": "B1", "tier": "Basic" },
              "kind": "linux",
              "properties": { "reserved": true }
            },
            {
              "type": "Microsoft.ContainerRegistry/registries",
              "apiVersion": "2023-07-01",
              "name": "[variables('acrName')]",
              "location": "[parameters('region')]",
              "sku": { "name": "Basic" },
              "properties": { "adminUserEnabled": true }
            },
            {
              "type": "Microsoft.DBforPostgreSQL/flexibleServers",
              "apiVersion": "2022-12-01",
              "name": "[variables('postgresServerName')]",
              "location": "[parameters('region')]",
              "sku": { "name": "Standard_B1ms", "tier": "Burstable" },
              "properties": {
                "administratorLogin": "petclinic_admin",
                "administratorLoginPassword": "[parameters('dbAdminPassword')]",
                "version": "13",
                "storage": { "storageSizeGB": 32 },
                "backup": { "backupRetentionDays": 7, "geoRedundantBackup": "Disabled" },
                "network": { "delegatedSubnetResourceId": null, "privateDnsZoneArmResourceId": null },
                "highAvailability": { "mode": "Disabled" }
              },
              "resources": [
                {
                  "type": "databases",
                  "apiVersion": "2022-12-01",
                  "name": "[variables('databaseName')]",
                  "dependsOn": [
                    "[resourceId('Microsoft.DBforPostgreSQL/flexibleServers', variables('postgresServerName'))]"
                  ],
                  "properties": { "charset": "UTF8", "collation": "en_US.utf8" }
                },
                {
                  "type": "firewallRules",
                  "apiVersion": "2022-12-01",
                  "name": "AllowAzureServices",
                  "dependsOn": [
                    "[resourceId('Microsoft.DBforPostgreSQL/flexibleServers', variables('postgresServerName'))]"
                  ],
                  "properties": { "startIpAddress": "0.0.0.0", "endIpAddress": "0.0.0.0" }
                }
              ]
            },
            {
              "type": "Microsoft.Web/sites",
              "apiVersion": "2022-03-01",
              "name": "[variables('webAppName')]",
              "location": "[parameters('region')]",
              "kind": "app,linux,container",
              "dependsOn": [
                "[resourceId('Microsoft.Web/serverfarms', variables('appServicePlanName'))]",
                "[resourceId('Microsoft.DBforPostgreSQL/flexibleServers', variables('postgresServerName'))]",
                "[resourceId('Microsoft.DBforPostgreSQL/flexibleServers/databases', variables('postgresServerName'), variables('databaseName'))]",
                "[resourceId('Microsoft.ContainerRegistry/registries', variables('acrName'))]"
              ],
              "properties": {
                "serverFarmId": "[resourceId('Microsoft.Web/serverfarms', variables('appServicePlanName'))]",
                "siteConfig": {
                  "linuxFxVersion": "DOCKER|mcr.microsoft.com/appsvc/staticsite:latest",
                  "appSettings": [
                    { "name": "DOCKER_REGISTRY_SERVER_URL", "value": "[format('https://{0}.azurecr.io', variables('acrName'))]" },
                    { "name": "DOCKER_REGISTRY_SERVER_USERNAME", "value": "[listCredentials(resourceId('Microsoft.ContainerRegistry/registries', variables('acrName')), '2023-07-01').username]" },
                    { "name": "DOCKER_REGISTRY_SERVER_PASSWORD", "value": "[listCredentials(resourceId('Microsoft.ContainerRegistry/registries', variables('acrName')), '2023-07-01').passwords[0].value]" },
                    { "name": "SPRING_PROFILES_ACTIVE", "value": "postgres" },
                    { "name": "SPRING_DATASOURCE_URL", "value": "[format('jdbc:postgresql://{0}.postgres.database.azure.com:5432/{1}', variables('postgresServerName'), variables('databaseName'))]" },
                    { "name": "SPRING_DATASOURCE_USERNAME", "value": "petclinic_admin" },
                    { "name": "SPRING_DATASOURCE_PASSWORD", "value": "[parameters('dbAdminPassword')]" }
                  ]
                }
              }
            }
          ]
        },
        "parameters": {
          "environmentName": { "value": "dev" },
          "region": { "value": "[parameters('region')]" },
          "dbAdminPassword": { "value": "[variables('dbAdminPassword')]" }
        }
      }
    },

    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2021-04-01",
      "name": "Deploy-PetClinic-Testing",
      "resourceGroup": "[variables('rgTest')]",
      "dependsOn": [
        "[resourceId('Microsoft.Resources/resourceGroups', variables('rgTest'))]"
      ],
      "properties": {
        "expressionEvaluationOptions": { "scope": "inner" },
        "mode": "Incremental",
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "parameters": {
            "environmentName": { "type": "string" },
            "region": { "type": "string" },
            "dbAdminPassword": { "type": "secureString" }
          },
          "variables": {
            "uniqueSuffix": "[substring(uniqueString(resourceGroup().id), 0, 6)]",
            "appServicePlanName": "[format('plan-petclinic-{0}', parameters('environmentName'))]",
            "webAppName": "[format('app-petclinic-{0}-{1}', parameters('environmentName'), variables('uniqueSuffix'))]",
            "postgresServerName": "[format('db-petclinic-{0}-{1}', parameters('environmentName'), variables('uniqueSuffix'))]",
            "databaseName": "petclinic",
            "acrName": "[format('acrpetclinic{0}{1}', parameters('environmentName'), variables('uniqueSuffix'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Web/serverfarms",
              "apiVersion": "2022-03-01",
              "name": "[variables('appServicePlanName')]",
              "location": "[parameters('region')]",
              "sku": { "name": "B1", "tier": "Basic" },
              "kind": "linux",
              "properties": { "reserved": true }
            },
            {
              "type": "Microsoft.ContainerRegistry/registries",
              "apiVersion": "2023-07-01",
              "name": "[variables('acrName')]",
              "location": "[parameters('region')]",
              "sku": { "name": "Basic" },
              "properties": { "adminUserEnabled": true }
            },
            {
              "type": "Microsoft.DBforPostgreSQL/flexibleServers",
              "apiVersion": "2022-12-01",
              "name": "[variables('postgresServerName')]",
              "location": "[parameters('region')]",
              "sku": { "name": "Standard_B1ms", "tier": "Burstable" },
              "properties": {
                "administratorLogin": "petclinic_admin",
                "administratorLoginPassword": "[parameters('dbAdminPassword')]",
                "version": "13",
                "storage": { "storageSizeGB": 32 },
                "backup": { "backupRetentionDays": 7, "geoRedundantBackup": "Disabled" },
                "network": { "delegatedSubnetResourceId": null, "privateDnsZoneArmResourceId": null },
                "highAvailability": { "mode": "Disabled" }
              },
              "resources": [
                {
                  "type": "databases",
                  "apiVersion": "2022-12-01",
                  "name": "[variables('databaseName')]",
                  "dependsOn": [
                    "[resourceId('Microsoft.DBforPostgreSQL/flexibleServers', variables('postgresServerName'))]"
                  ],
                  "properties": { "charset": "UTF8", "collation": "en_US.utf8" }
                },
                {
                  "type": "firewallRules",
                  "apiVersion": "2022-12-01",
                  "name": "AllowAzureServices",
                  "dependsOn": [
                    "[resourceId('Microsoft.DBforPostgreSQL/flexibleServers', variables('postgresServerName'))]"
                  ],
                  "properties": { "startIpAddress": "0.0.0.0", "endIpAddress": "0.0.0.0" }
                }
              ]
            },
            {
              "type": "Microsoft.Web/sites",
              "apiVersion": "2022-03-01",
              "name": "[variables('webAppName')]",
              "location": "[parameters('region')]",
              "kind": "app,linux,container",
              "dependsOn": [
                "[resourceId('Microsoft.Web/serverfarms', variables('appServicePlanName'))]",
                "[resourceId('Microsoft.DBforPostgreSQL/flexibleServers', variables('postgresServerName'))]",
                "[resourceId('Microsoft.DBforPostgreSQL/flexibleServers/databases', variables('postgresServerName'), variables('databaseName'))]",
                "[resourceId('Microsoft.ContainerRegistry/registries', variables('acrName'))]"
              ],
              "properties": {
                "serverFarmId": "[resourceId('Microsoft.Web/serverfarms', variables('appServicePlanName'))]",
                "siteConfig": {
                  "linuxFxVersion": "DOCKER|mcr.microsoft.com/appsvc/staticsite:latest",
                  "appSettings": [
                    { "name": "DOCKER_REGISTRY_SERVER_URL", "value": "[format('https://{0}.azurecr.io', variables('acrName'))]" },
                    { "name": "DOCKER_REGISTRY_SERVER_USERNAME", "value": "[listCredentials(resourceId('Microsoft.ContainerRegistry/registries', variables('acrName')), '2023-07-01').username]" },
                    { "name": "DOCKER_REGISTRY_SERVER_PASSWORD", "value": "[listCredentials(resourceId('Microsoft.ContainerRegistry/registries', variables('acrName')), '2023-07-01').passwords[0].value]" },
                    { "name": "SPRING_PROFILES_ACTIVE", "value": "postgres" },
                    { "name": "SPRING_DATASOURCE_URL", "value": "[format('jdbc:postgresql://{0}.postgres.database.azure.com:5432/{1}', variables('postgresServerName'), variables('databaseName'))]" },
                    { "name": "SPRING_DATASOURCE_USERNAME", "value": "petclinic_admin" },
                    { "name": "SPRING_DATASOURCE_PASSWORD", "value": "[parameters('dbAdminPassword')]" }
                  ]
                }
              }
            }
          ]
        },
        "parameters": {
          "environmentName": { "value": "testing" },
          "region": { "value": "[parameters('region')]" },
          "dbAdminPassword": { "value": "[variables('dbAdminPassword')]" }
        }
      }
    },

    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2021-04-01",
      "name": "Deploy-PetClinic-Prod",
      "resourceGroup": "[variables('rgProd')]",
      "dependsOn": [
        "[resourceId('Microsoft.Resources/resourceGroups', variables('rgProd'))]"
      ],
      "properties": {
        "expressionEvaluationOptions": { "scope": "inner" },
        "mode": "Incremental",
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "parameters": {
            "environmentName": { "type": "string" },
            "region": { "type": "string" },
            "dbAdminPassword": { "type": "secureString" }
          },
          "variables": {
            "uniqueSuffix": "[substring(uniqueString(resourceGroup().id), 0, 6)]",
            "appServicePlanName": "[format('plan-petclinic-{0}', parameters('environmentName'))]",
            "webAppName": "[format('app-petclinic-{0}-{1}', parameters('environmentName'), variables('uniqueSuffix'))]",
            "postgresServerName": "[format('db-petclinic-{0}-{1}', parameters('environmentName'), variables('uniqueSuffix'))]",
            "databaseName": "petclinic",
            "acrName": "[format('acrpetclinic{0}{1}', parameters('environmentName'), variables('uniqueSuffix'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Web/serverfarms",
              "apiVersion": "2022-03-01",
              "name": "[variables('appServicePlanName')]",
              "location": "[parameters('region')]",
              "sku": { "name": "B1", "tier": "Basic" },
              "kind": "linux",
              "properties": { "reserved": true }
            },
            {
              "type": "Microsoft.ContainerRegistry/registries",
              "apiVersion": "2023-07-01",
              "name": "[variables('acrName')]",
              "location": "[parameters('region')]",
              "sku": { "name": "Basic" },
              "properties": { "adminUserEnabled": true }
            },
            {
              "type": "Microsoft.DBforPostgreSQL/flexibleServers",
              "apiVersion": "2022-12-01",
              "name": "[variables('postgresServerName')]",
              "location": "[parameters('region')]",
              "sku": { "name": "Standard_B1ms", "tier": "Burstable" },
              "properties": {
                "administratorLogin": "petclinic_admin",
                "administratorLoginPassword": "[parameters('dbAdminPassword')]",
                "version": "13",
                "storage": { "storageSizeGB": 32 },
                "backup": { "backupRetentionDays": 7, "geoRedundantBackup": "Disabled" },
                "network": { "delegatedSubnetResourceId": null, "privateDnsZoneArmResourceId": null },
                "highAvailability": { "mode": "Disabled" }
              },
              "resources": [
                {
                  "type": "databases",
                  "apiVersion": "2022-12-01",
                  "name": "[variables('databaseName')]",
                  "dependsOn": [
                    "[resourceId('Microsoft.DBforPostgreSQL/flexibleServers', variables('postgresServerName'))]"
                  ],
                  "properties": { "charset": "UTF8", "collation": "en_US.utf8" }
                },
                {
                  "type": "firewallRules",
                  "apiVersion": "2022-12-01",
                  "name": "AllowAzureServices",
                  "dependsOn": [
                    "[resourceId('Microsoft.DBforPostgreSQL/flexibleServers', variables('postgresServerName'))]"
                  ],
                  "properties": { "startIpAddress": "0.0.0.0", "endIpAddress": "0.0.0.0" }
                }
              ]
            },
            {
              "type": "Microsoft.Web/sites",
              "apiVersion": "2022-03-01",
              "name": "[variables('webAppName')]",
              "location": "[parameters('region')]",
              "kind": "app,linux,container",
              "dependsOn": [
                "[resourceId('Microsoft.Web/serverfarms', variables('appServicePlanName'))]",
                "[resourceId('Microsoft.DBforPostgreSQL/flexibleServers', variables('postgresServerName'))]",
                "[resourceId('Microsoft.DBforPostgreSQL/flexibleServers/databases', variables('postgresServerName'), variables('databaseName'))]",
                "[resourceId('Microsoft.ContainerRegistry/registries', variables('acrName'))]"
              ],
              "properties": {
                "serverFarmId": "[resourceId('Microsoft.Web/serverfarms', variables('appServicePlanName'))]",
                "siteConfig": {
                  "linuxFxVersion": "DOCKER|mcr.microsoft.com/appsvc/staticsite:latest",
                  "appSettings": [
                    { "name": "DOCKER_REGISTRY_SERVER_URL", "value": "[format('https://{0}.azurecr.io', variables('acrName'))]" },
                    { "name": "DOCKER_REGISTRY_SERVER_USERNAME", "value": "[listCredentials(resourceId('Microsoft.ContainerRegistry/registries', variables('acrName')), '2023-07-01').username]" },
                    { "name": "DOCKER_REGISTRY_SERVER_PASSWORD", "value": "[listCredentials(resourceId('Microsoft.ContainerRegistry/registries', variables('acrName')), '2023-07-01').passwords[0].value]" },
                    { "name": "SPRING_PROFILES_ACTIVE", "value": "postgres" },
                    { "name": "SPRING_DATASOURCE_URL", "value": "[format('jdbc:postgresql://{0}.postgres.database.azure.com:5432/{1}', variables('postgresServerName'), variables('databaseName'))]" },
                    { "name": "SPRING_DATASOURCE_USERNAME", "value": "petclinic_admin" },
                    { "name": "SPRING_DATASOURCE_PASSWORD", "value": "[parameters('dbAdminPassword')]" }
                  ]
                }
              }
            }
          ]
        },
        "parameters": {
          "environmentName": { "value": "prod" },
          "region": { "value": "[parameters('region')]" },
          "dbAdminPassword": { "value": "[variables('dbAdminPassword')]" }
        }
      }
    },

    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2021-04-01",
      "name": "Deploy-SonarQube",
      "resourceGroup": "[variables('rgSonar')]",
      "dependsOn": [
        "[resourceId('Microsoft.Resources/resourceGroups', variables('rgSonar'))]"
      ],
      "properties": {
        "expressionEvaluationOptions": { "scope": "inner" },
        "mode": "Incremental",
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "parameters": {
            "appName": { "type": "string" },
            "region": { "type": "string" },
            "sku": { "type": "string", "defaultValue": "B2" },
            "dockerImage": { "type": "string", "defaultValue": "DOCKER|sonarqube:community" }
          },
          "variables": {
            "appServicePlanName": "[format('plan-{0}', parameters('appName'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Web/serverfarms",
              "apiVersion": "2022-03-01",
              "name": "[variables('appServicePlanName')]",
              "location": "[parameters('region')]",
              "kind": "linux",
              "sku": { "name": "[parameters('sku')]" },
              "properties": { "reserved": true }
            },
            {
              "type": "Microsoft.Web/sites",
              "apiVersion": "2022-03-01",
              "name": "[parameters('appName')]",
              "location": "[parameters('region')]",
              "dependsOn": [
                "[resourceId('Microsoft.Web/serverfarms', variables('appServicePlanName'))]"
              ],
              "properties": {
                "serverFarmId": "[resourceId('Microsoft.Web/serverfarms', variables('appServicePlanName'))]",
                "siteConfig": {
                  "linuxFxVersion": "[parameters('dockerImage')]",
                  "appSettings": [
                    { "name": "SONAR_ES_BOOTSTRAP_CHECKS_DISABLE", "value": "true" },
                    { "name": "WEBSITES_PORT", "value": "9000" },
                    { "name": "WEBSITES_CONTAINER_START_TIME_LIMIT", "value": "600" }
                  ]
                }
              }
            }
          ]
        },
        "parameters": {
          "appName": { "value": "[variables('sonarAppName')]" },
          "region": { "value": "[parameters('region')]" }
        }
      }
    }
  ]
}
